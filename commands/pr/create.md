---
name: pr-create
description: Create pull request from track branch. Uses external MCPs (GitHub, GitLab, Gitea) when available, falls back to CLI tools (gh, glab, tea).
category: pr
version: 0.1.0
---

# Create Pull Request

## Purpose

Create a pull request (PR) from a completed track branch to a target branch. This command uses external MCP providers when available, or falls back to CLI tools for PR creation.

## When to Use

Use this command when:
- Track is completed and ready for review
- Want to create PR before merging locally
- Working with remote team requiring PR workflow
- Need PR for audit/approval process
- Want to trigger CI/CD pipeline on PR

## Prerequisites

- Git repository with remote configured
- Track branch exists and has commits
- Remote repository supports pull requests (GitHub, GitLab, Gitea)
- Authentication configured for remote provider
- External MCP or CLI tool available (gh, glab, tea)

## Command Invocation

```
/workflow:pr-create {track_id} [--base <branch>] [--draft] [--title <title>] [--body <body>]
```

**Parameters:**
- `track_id` (required): Track ID / branch name for the PR
- `--base <branch>` (optional): Target branch (default: main)
- `--draft` (optional): Create as draft PR
- `--title <title>` (optional): PR title (auto-generated if not provided)
- `--body <body>` (optional): PR description (auto-generated if not provided)

## Execution Steps

### 1. Detect Remote Provider

Determine which remote provider is being used:

```bash
# Get remote URL
git remote get-url origin

# Detect provider from URL
# GitHub: github.com
# GitLab: gitlab.com or self-hosted
# Gitea: self-hosted
# Bitbucket: bitbucket.org
```

**Provider Detection:**
```javascript
const remoteUrl = execSync('git remote get-url origin').toString().trim();

if (remoteUrl.includes('github.com')) {
  provider = 'github';
} else if (remoteUrl.includes('gitlab.com') || remoteUrl.includes('gitlab')) {
  provider = 'gitlab';
} else if (remoteUrl.includes('gitea')) {
  provider = 'gitea';
} else {
  provider = 'unknown';
}
```

### 2. Check for External MCP

Check if external MCP is available for the provider:

```bash
# Check for available MCPs
# (This depends on Claude's MCP configuration)

# GitHub MCP: github_mcp
# GitLab MCP: gitlab_mcp
# Gitea MCP: gitea_mcp
```

**MCP Availability Check:**
- Query available tools from Claude's environment
- Look for PR creation capabilities
- Prefer MCP over CLI when available

**MCP Benefits:**
- Authenticated access
- Native API integration
- Better error handling
- Consistent interface

### 3. Prepare Branch for PR

Ensure branch is ready:

```bash
# Push branch to remote if not already pushed
git push -u origin {track_id}

# Verify branch exists on remote
git ls-remote --heads origin {track_id}

# Check commits ahead of base branch
git log origin/{base_branch}..{track_id} --oneline
```

**Pre-Flight Checks:**
- ✓ Branch has commits to create PR for
- ✓ Branch is pushed to remote
- ✓ Base branch exists on remote
- ✓ No merge conflicts with base branch

### 4. Generate PR Content

Auto-generate title and body if not provided:

**PR Title:**
```javascript
// Read track plan
const planPath = `.workflow/plans/${trackId}.md`;
const plan = readFile(planPath);

// Extract title from plan frontmatter or first heading
const title = extractTitle(plan) || `Track: ${trackId}`;

// Format: "[Type] Brief description"
const prTitle = formatTitle(title);
// Example: "feat: Implement user authentication"
```

**PR Body:**
```markdown
## Summary

{Brief description of changes from plan overview}

## Changes

{List of completed tasks from plan}

- [x] Task 1: {description}
- [x] Task 2: {description}
- [x] Task 3: {description}

## Test Plan

{Test strategy from plan}

## Verification

✓ All tests passing
✓ Code review completed (if applicable)
✓ Coverage: {percentage}%

## Related Issues

{Links to related issues if any}

---

Track Details: `.workflow/plans/{track_id}.md`

Generated by Adaptive Workflow Plugin
```

**Content Sources:**
- Plan file: `.workflow/plans/{track_id}.md`
- Completed tasks: Checkboxes in plan
- Test results: From verification phase
- Commit history: `git log origin/{base}..{track_id}`

### 5. Create PR via MCP (Preferred)

If external MCP is available, use it:

#### GitHub MCP

```javascript
// Using GitHub MCP
await mcp.github.createPullRequest({
  owner: extractOwner(remoteUrl),
  repo: extractRepo(remoteUrl),
  title: prTitle,
  body: prBody,
  head: trackId,
  base: baseBranch,
  draft: isDraft
});
```

#### GitLab MCP

```javascript
// Using GitLab MCP
await mcp.gitlab.createMergeRequest({
  projectId: extractProjectId(remoteUrl),
  title: prTitle,
  description: prBody,
  sourceBranch: trackId,
  targetBranch: baseBranch,
  draft: isDraft
});
```

#### Gitea MCP

```javascript
// Using Gitea MCP
await mcp.gitea.createPullRequest({
  owner: extractOwner(remoteUrl),
  repo: extractRepo(remoteUrl),
  title: prTitle,
  body: prBody,
  head: trackId,
  base: baseBranch
});
```

### 6. Create PR via CLI (Fallback)

If MCP is not available, use CLI tools:

#### GitHub CLI (gh)

```bash
# Check if gh is installed
which gh || echo "GitHub CLI not found"

# Authenticate if needed
gh auth status || gh auth login

# Create PR
gh pr create \
  --title "${prTitle}" \
  --body "${prBody}" \
  --base ${baseBranch} \
  --head ${trackId} \
  ${isDraft && --draft}

# Get PR URL
gh pr view ${trackId} --json url -q .url
```

#### GitLab CLI (glab)

```bash
# Check if glab is installed
which glab || echo "GitLab CLI not found"

# Authenticate if needed
glab auth status || glab auth login

# Create merge request
glab mr create \
  --title "${prTitle}" \
  --description "${prBody}" \
  --source-branch ${trackId} \
  --target-branch ${baseBranch} \
  ${isDraft && --draft}

# Get MR URL
glab mr view ${trackId} --json webUrl -q .webUrl
```

#### Gitea CLI (tea)

```bash
# Check if tea is installed
which tea || echo "Gitea CLI not found"

# Authenticate if needed
tea login

# Create pull request
tea pr create \
  --title "${prTitle}" \
  --description "${prBody}" \
  --head ${trackId} \
  --base ${baseBranch}
```

### 7. Handle PR Creation Errors

Common errors and solutions:

**Error: Authentication failed**
```bash
# Solution: Authenticate with provider
gh auth login        # GitHub
glab auth login      # GitLab
tea login            # Gitea
```

**Error: Branch not found on remote**
```bash
# Solution: Push branch first
git push -u origin ${trackId}
```

**Error: Base branch does not exist**
```bash
# Solution: Verify base branch name
git ls-remote --heads origin
```

**Error: PR already exists**
```bash
# Solution: Update existing PR or use different branch
gh pr list --head ${trackId}
```

### 8. Update Session State

Record PR in `.workflow/state/session_state.json`:

```json
{
  "tracks": [
    {
      "track_id": "user-auth_20260203",
      "pull_request": {
        "provider": "github",
        "url": "https://github.com/user/repo/pull/123",
        "number": 123,
        "state": "open",
        "draft": false,
        "created_at": "2026-02-03T12:00:00Z",
        "created_via": "mcp"
      }
    }
  ]
}
```

### 9. Post-PR Actions

After PR creation:

```bash
# Add PR link to plan file
echo "\n## Pull Request\n${prUrl}" >> .workflow/plans/${trackId}.md

# Create PR comment with workflow details (optional)
gh pr comment ${prNumber} --body "Workflow plan: .workflow/plans/${trackId}.md"

# Request reviewers (optional)
gh pr review ${prNumber} --request-reviewer ${reviewers}

# Add labels (optional)
gh pr label ${prNumber} --add "workflow:${trackType}"
```

## Output

Provide PR creation summary:

```
✓ Pull request created successfully

Provider:     GitHub
PR Number:    #123
PR URL:       https://github.com/user/repo/pull/123
Status:       Open
Draft:        No

Title:        feat: Implement user authentication

Base Branch:  main
Head Branch:  user-auth_20260203
Commits:      5 commits
Files:        8 files changed

Created via:  GitHub MCP

Next steps:
1. Request reviews from team members
2. Wait for CI/CD checks to pass
3. Address review comments
4. Merge PR when approved
```

## Provider-Specific Features

### GitHub

**Features:**
- Draft PRs
- PR templates
- Auto-linked issues (#123)
- Review requests
- Labels and milestones
- CI/CD integration (Actions)

**Commands:**
```bash
# Convert draft to ready
gh pr ready ${prNumber}

# Request reviewers
gh pr review ${prNumber} --request-reviewer @user

# Auto-merge when approved
gh pr merge ${prNumber} --auto --squash
```

### GitLab

**Features:**
- Merge requests (MRs)
- Draft MRs (WIP:)
- Approval rules
- Merge trains
- CI/CD pipelines

**Commands:**
```bash
# Mark as ready
glab mr update ${mrNumber} --ready

# Approve MR
glab mr approve ${mrNumber}

# Merge when pipeline succeeds
glab mr merge ${mrNumber} --when-pipeline-succeeds
```

### Gitea

**Features:**
- Pull requests
- Review workflow
- Webhooks
- Gitea Actions (CI/CD)

**Commands:**
```bash
# Create PR with tea
tea pr create --title "..." --body "..." --head ${head} --base ${base}

# Close PR
tea pr close ${prNumber}
```

## Best Practices

### PR Title Conventions

Follow conventional commits:
- `feat: Add new feature`
- `fix: Fix bug in component`
- `refactor: Restructure module`
- `docs: Update documentation`
- `test: Add tests for feature`

### PR Description Template

```markdown
## What

Brief description of changes

## Why

Reason for changes / problem being solved

## How

Technical approach / implementation details

## Testing

How to test these changes

## Checklist

- [ ] Tests pass
- [ ] Documentation updated
- [ ] No breaking changes (or documented)
```

### PR Size

- **Small:** < 200 lines, easy to review
- **Medium:** 200-500 lines, requires focus
- **Large:** > 500 lines, consider splitting

**Recommendation:** Keep PRs small and focused

### PR Review Process

1. Create PR (this command)
2. Self-review changes
3. Request reviewers
4. Address feedback
5. Merge when approved

## Common Issues

### Issue: "gh: command not found"

**Cause:** GitHub CLI not installed

**Solution:**
```bash
# Install GitHub CLI
# macOS
brew install gh

# Linux
curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
sudo apt update
sudo apt install gh

# Authenticate
gh auth login
```

### Issue: "failed to authenticate"

**Cause:** No authentication credentials

**Solution:**
```bash
# GitHub
gh auth login
gh auth status

# GitLab
glab auth login
glab auth status

# Configure git credentials
git config --global credential.helper store
```

### Issue: "PR already exists for this branch"

**Cause:** PR was already created for this branch

**Solution:**
```bash
# View existing PR
gh pr list --head ${trackId}

# Update existing PR instead
gh pr edit ${prNumber} --title "..." --body "..."

# Or close old PR and create new one
gh pr close ${prNumber}
```

### Issue: Merge conflicts in PR

**Cause:** Base branch has diverged

**Solution:**
```bash
# Update branch with base changes
git checkout ${trackId}
git pull origin ${baseBranch}
git push origin ${trackId}

# Or rebase onto base
git rebase origin/${baseBranch}
git push --force-with-lease origin ${trackId}
```

## MCP vs CLI Comparison

| Feature | MCP | CLI |
|---------|-----|-----|
| **Authentication** | Handled by MCP | Manual login required |
| **Error Handling** | Structured errors | Parse CLI output |
| **Performance** | API calls (fast) | CLI invocation (slower) |
| **Availability** | Requires MCP setup | Requires CLI install |
| **Consistency** | Uniform interface | Provider-specific |

**Recommendation:** Use MCP when available, fallback to CLI.

## Integration with Workflow

### Phase 5: Review Process

```
Track Complete (Phase 4)
         ↓
Create PR (This Command)
         ↓
Team Review
         ↓
Address Feedback
         ↓
PR Approved
         ↓
Merge via PR or Local Merge
```

### PR-First vs Merge-First

**PR-First (Recommended for teams):**
1. Complete track
2. Create PR
3. Wait for review/approval
4. Merge via PR interface
5. Clean up local worktree

**Merge-First (Solo or trusted):**
1. Complete track
2. Merge locally
3. Push to remote
4. Create PR for audit (optional)

## Related Commands

- `/workflow:pr-review` - Review existing PR
- `/workflow:worktree-merge` - Merge without PR
- `/workflow:review` - Run local code review
- `/workflow:status` - View PR status for tracks

## Technical Notes

### PR Creation Flow

```
Local Branch → Push to Remote → Create PR → CI/CD Runs → Review → Merge
```

### Remote Branch Requirements

- Branch must be pushed to remote
- Remote must be accessible (auth)
- Base branch must exist on remote
- No force-push after PR creation (breaks review)

### Draft PRs

Draft PRs allow:
- Early feedback
- Work-in-progress visibility
- CI/CD testing before review
- Convert to ready when complete

## Security Considerations

- Authentication tokens stored securely
- MCP handles credentials (preferred)
- CLI tools use OS keychain
- Never commit tokens to repository
- Use fine-grained permissions when possible

## Summary

This command creates a pull request with:
- ✓ Auto-generated title and description
- ✓ MCP or CLI-based creation
- ✓ Provider detection (GitHub/GitLab/Gitea)
- ✓ Session state tracking
- ✓ Error handling and fallbacks
- ✓ Integration with workflow plans

The PR is now open and ready for review.
